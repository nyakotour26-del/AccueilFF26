// ===== FONCTION : FORMATER LA LOCALISATION AVEC APERÃ‡U DE CARTE =====
function formatLocationWithMapPreview(text, coordText = '', locationName = '') {
    if (!text) return '';
    
    // DÃ©tecter les URLs Google Maps
    const urlRegex = /(https?:\/\/[^\s<]+)/g;
    const urls = text.match(urlRegex);
    
    let hasMapPreview = false;
    let mapPreviewHtml = '';
    
    // ===== CAS 1 : COORDONNÃ‰ES EXACTES =====
    if (coordText && coordText.trim() !== '') {
        const coords = extractCoordinatesFromCell(coordText);
        if (coords) {
            const [lat, lng] = coords;
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            
            mapPreviewHtml = `
                <div class="map-preview-container" id="${'map-' + Math.random().toString(36).substr(2, 9)}">
                    <div style="margin-bottom: 6px; font-size: 0.7rem; color: #4a5568; font-weight: 600;">
                        <i class="fas fa-map-pin"></i> Localisation exacte:
                    </div>
                    
                    <!-- ðŸ”¥ BOUTONS AU-DESSUS DE LA CARTE -->
                    <div style="display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap;">
                        <a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=15/${lat}/${lng}" target="_blank" style="flex: 1; min-width: 70px; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 5px 5px; background: #4299e1; color: white; border: none; border-radius: 5px; font-size: 0.65rem; font-weight: 600; text-decoration: none;">
                            <i class="fas fa-map"></i> OSM
                        </a>
                        <a href="${googleMapsUrl}" target="_blank" style="flex: 1; min-width: 70px; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 5px 5px; background: #ea4335; color: white; border: none; border-radius: 5px; font-size: 0.65rem; font-weight: 600; text-decoration: none;">
                            <i class="fab fa-google"></i> Google
                        </a>
                        <a href="https://waze.com/ul?ll=${lat},${lng}&navigate=yes" target="_blank" style="flex: 1; min-width: 70px; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 5px 5px; background: #33CCFF; color: white; border: none; border-radius: 5px; font-size: 0.65rem; font-weight: 600; text-decoration: none;">
                            <i class="fas fa-car"></i> Waze
                        </a>
                        <button onclick="copyToClipboard('${coordText}')" style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 5px 8px; background: #718096; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.65rem; font-weight: 600;">
                            <i class="fas fa-copy"></i> ðŸ“‹
                        </button>
                    </div>
                    
                    <!-- APERÃ‡U CARTE -->
                    <div style="position: relative; width: 100%; height: 160px; background: #f0f9ff; border-radius: 6px; overflow: hidden; border: 1px solid #e2e8f0; margin-bottom: 5px;">
                        <iframe 
                            width="100%" 
                            height="100%" 
                            frameborder="0" 
                            scrolling="no" 
                            marginheight="0" 
                            marginwidth="0"
                            src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.02},${lat-0.02},${lng+0.02},${lat+0.02}&layer=mapnik&marker=${lat},${lng}"
                            style="border: 0; display: block;">
                        </iframe>
                    </div>
                    
                    <div style="font-size: 0.6rem; color: #718096; text-align: center;">
                        <i class="fas fa-info-circle"></i> ${lat.toFixed(5)}, ${lng.toFixed(5)}
                    </div>
                </div>
            `;
            hasMapPreview = true;
        }
    }
    
    // ===== CAS 2 : URL GOOGLE MAPS SANS COORDONNÃ‰ES =====
    if (!hasMapPreview && urls && urls.length > 0) {
        const url = urls[0];
        mapPreviewHtml = `
            <div class="map-preview-container">
                <div style="margin-bottom: 6px; font-size: 0.7rem; color: #4a5568; font-weight: 600;">
                    <i class="fas fa-link"></i> Lien de localisation:
                </div>
                
                <!-- ðŸ”¥ BOUTONS AU-DESSUS -->
                <div style="display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap;">
                    <a href="${url}" target="_blank" style="flex: 1; min-width: 80px; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 5px 5px; background: #ea4335; color: white; border: none; border-radius: 5px; font-size: 0.65rem; font-weight: 600; text-decoration: none;">
                        <i class="fab fa-google"></i> Google
                    </a>
                    <a href="https://waze.com/ul?q=${encodeURIComponent(url)}" target="_blank" style="flex: 1; min-width: 80px; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 5px 5px; background: #33CCFF; color: white; border: none; border-radius: 5px; font-size: 0.65rem; font-weight: 600; text-decoration: none;">
                        <i class="fas fa-car"></i> Waze
                    </a>
                    <button onclick="copyToClipboard('${url}')" style="flex: 0 0 auto; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 5px 8px; background: #718096; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.65rem; font-weight: 600;">
                        <i class="fas fa-copy"></i> ðŸ“‹
                    </button>
                </div>
                
                <!-- LIEN DIRECT -->
                <div style="background: #f8fafc; padding: 8px; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <div class="link-with-copy" style="display: flex; align-items: center; gap: 4px;">
                        <a href="${url}" class="link-blue" target="_blank" style="flex: 1; word-break: break-all; font-size: 0.65rem;">${url.length > 40 ? url.substring(0, 40) + '...' : url}</a>
                    </div>
                </div>
            </div>
        `;
        hasMapPreview = true;
    }
    
    // ===== CAS 3 : TEXTE SEULEMENT =====
    if (!hasMapPreview) {
        return `<div style="font-size: 0.75rem; color: #4a5568;">${text}</div>`;
    }
    
    return mapPreviewHtml;
}
